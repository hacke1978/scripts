clear all; close all; userpath('clear'); userpath('reset');
% Run fieldtrip analysis for NatImFix paradigm
%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Author: Cem Uran
% cem.uran@esi-frankfurt.de
% 09/07/17
%%%%%%%%%%%%%%%%%%%%%%%%%%%
batchTag = '';  %analysis tag
sesType = 'NatImFix'; % 'NatImSEQ' 'grating-ori' 'rfmapping-bar'

dataDir = '/mnt/hpx/projects/MWNaturalPredict';
saveDir = '/mnt/v7k/projects/MWNaturalPredict/Cem/Analysis';

sessionList = {...
  'hermes_20170613_fixation-naturalim_59',...
    'hermes_20170614_fixation-naturalim_61',...
    'hermes_20170616_fixation-naturalim_62',...
    'hermes_20170619_fixation-naturalim_63',...
    'hermes_20170620_fixation-naturalim_64',...
    'hermes_20170620_fixation-naturalim_64b',...
    'hermes_20170623_fixation-naturalim_65',...
    'hermes_20170623_fixation-naturalim_66',...
    'hermes_20170626_fixation-naturalim_66',...
    'hermes_20170626_fixation-naturalim_67',...
    'hermes_20170627_fixation-naturalim_68',...
    'hermes_20170627_fixation-naturalim_68b',...
    'hermes_20170628_fixation-naturalim_69',...
    'hermes_20170628_fixation-naturalim_70',...
    'hermes_20170629_fixation-naturalim_71',...
    'hermes_20170629_fixation-naturalim_72',...
    'hermes_20170630_fixation-naturalim_72',...
    'hermes_20170630_fixation-naturalim_73',...
    'hermes_20170703_fixation-naturalim_73',...
    'hermes_20171113_fixation-color-masksize_78',...
    'hermes_20171114_fixation-color-masksize_78b',...
    'hermes_20171115_fixation-color-masksize_79',...
    'hermes_20171116_fixation-color-masksize_78',...
    'hermes_20171117_fixation-color-masksize_79b',...
    'hermes_20171120_fixation-naturalim_80',...
    'hermes_20171120_fixation-naturalim_81',...
    'hermes_20171121_fixation-naturalim_82',...
    'hermes_20171121_fixation-naturalim_82b',...
    'hermes_20171122_fixation-naturalim_83',...
    'hermes_20171123_fixation-naturalim_84',...
    'hermes_20171123_fixation-naturalim_84b',...
    'hermes_20171124_fixation-naturalim_85',...
    'hermes_20171127_fixation-naturalim_80',...
    ...% %     'hermes_20171127_fixation-naturalim_86',...
    ...% %     'hermes_20171127_fixation-naturalim_87',...
    'hermes_20171128_fixation-naturalim_88',...
    'hermes_20171128_fixation-naturalim_89',...
    'hermes_20171129_fixation-naturalim_89',...
    'hermes_20171130_fixation-naturalim_85',...
    'hermes_20171130_fixation-naturalim_89',...
    'hermes_20171201_fixation-naturalim_90',...
    'hermes_20171204_fixation-naturalim_92',...
    'hermes_20171205_fixation-naturalim_93',... 
    };

%% Functions
cfg = [];
n = 0;
for ses = 1:length(sessionList)
    n = n + 1;
    
    % get monkey dirs
    monkeyName = sessionList{ses}(1:4);
    if strcmp(monkeyName, 'herm'); monkeyName = 'Hermes'; end
    if strcmp(monkeyName, 'ares'); monkeyName = 'Ares'; end
    if strcmp(monkeyName, 'isis'); monkeyName = 'Isis'; end
    
    newSave = fullfile(saveDir, sesType, monkeyName, sessionList{ses});
    newDir = fullfile(dataDir, monkeyName, sesType, sessionList{ses});
    
    if ~exist(newSave, 'dir')
        mkdir(newSave); mkdir(fullfile(newSave, 'data'));
    end
    
    % set dirs
    cfg{n}.inputfile = newDir;
    cfg{n}.outputfile = newSave;
    cfg{n}.name = monkeyName;
    cfg{n}.type = sesType;
    cfg{n}.tag = batchTag;
    
    % set processing
    cfg{n}.filterLineNoise = ~strcmp(monkeyName, 'Hermes');
    cfg{n}.getBadChannels = false;
    
    % set analysis options
    cfg{n}.runBaseline = true;
    cfg{n}.runErrorBars = true;
    cfg{n}.runPSTH = true;
    cfg{n}.runTimelockLFP = true;
    cfg{n}.runTimelockMUAX = true;
    cfg{n}.runConnectivity = false;
    cfg{n}.runTFR = true;
    cfg{n}.runSTA = false;
    cfg{n}.runSFC = true;
    
    % params
    cfg{n}.timeAll = [-0.5 1.2];
    cfg{n}.timeEvent = [0 1.2];
    cfg{n}.timeBaseline = [-0.5 0];
    cfg{n}.timeSustained = [0.25 0.75];
end

%% Run analysis
tdt_analysis_AP(cfg, 'slurm');
