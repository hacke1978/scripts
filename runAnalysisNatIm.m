clear all; close all; userpath('clear'); userpath('reset');
% Run fieldtrip analysis for NatImFix paradigm
%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Author: Cem Uran
% cem.uran@esi-frankfurt.de
% 09/07/17
%%%%%%%%%%%%%%%%%%%%%%%%%%%
batchTag = '';  %analysis tag
sesType = 'NatImSEQ'; %'NatImFix'; % 'NatImSEQ' 'grating-ori' 'rfmapping-bar'
% sesType =  'grating-ori';
dataDir = '/mnt/hpx/projects/MWNaturalPredict';
saveDir = '/mnt/hpx/projects/MWNaturalPredict/Cem/Analysis';
sessionList = {
    'hermes_20170531_fixation-naturalim_49',...
    'hermes_20170607_fixation-naturalim_57',...
    'hermes_20170608_fixation-naturalim_58',...
    'hermes_20170608_fixation-naturalim_58b',...
    'hermes_20170612_fixation-naturalim_57',...
    'hermes_20170613_fixation-naturalim_59',...
    'hermes_20170614_fixation-naturalim_61',...
    'hermes_20170616_fixation-naturalim_62',...
    'hermes_20170619_fixation-naturalim_63',...
    {
    'hermes_20170620_fixation-naturalim_64',...
    'hermes_20170620_fixation-naturalim_64b',...
    },...
    'hermes_20170623_fixation-naturalim_65',...
    'hermes_20170623_fixation-naturalim_66',...
    'hermes_20170626_fixation-naturalim_66',...
    'hermes_20170626_fixation-naturalim_67',...
    {
    'hermes_20170627_fixation-naturalim_68',...
    'hermes_20170627_fixation-naturalim_68b',...
    },...
    'hermes_20170628_fixation-naturalim_69',...
    'hermes_20170628_fixation-naturalim_70',...
    'hermes_20170629_fixation-naturalim_71',...
    'hermes_20170629_fixation-naturalim_72',...
    'hermes_20170630_fixation-naturalim_72',...
    'hermes_20170630_fixation-naturalim_73',...
    'hermes_20170703_fixation-naturalim_73',...
    'hermes_20170703_fixation-naturalim_74',...
    'hermes_20170704_fixation-naturalim_75',...
    'hermes_20170706_fixation-naturalim_76',...
    'hermes_20170706_fixation-naturalim_77',...
    'hermes_20170712_fixation-naturalim_60',...
    'hermes_20170724_fixation-naturalim_70',...
    'hermes_20170725_fixation-naturalim_71',...
    {
    'hermes_20171120_fixation-naturalim_80',...
    'hermes_20171127_fixation-naturalim_80',...
    },...
    'hermes_20171120_fixation-naturalim_81',...
    {
    'hermes_20171121_fixation-naturalim_82',...
    'hermes_20171121_fixation-naturalim_82b',...
    },...
    'hermes_20171122_fixation-naturalim_83',...
    {
    'hermes_20171123_fixation-naturalim_84',...
    'hermes_20171123_fixation-naturalim_84b',...
    },...
    {
    'hermes_20171124_fixation-naturalim_85',...
    'hermes_20171130_fixation-naturalim_85',...
    },...
    {
    'hermes_20171128_fixation-naturalim_88',...
    'hermes_20171206_fixation-naturalim_88'
    },...
    {
    'hermes_20171128_fixation-naturalim_89',...
    'hermes_20171129_fixation-naturalim_89',...
    'hermes_20171130_fixation-naturalim_89',...
    'hermes_20171206_fixation-naturalim_89',...
    },...
    'hermes_20171201_fixation-naturalim_90',...
    'hermes_20171204_fixation-naturalim_92',...
    'hermes_20171205_fixation-naturalim_93',...
    'hermes_20171206_fixation-naturalim_88',...
    'hermes_20171206_fixation-naturalim_89',...
    'hermes_20171207_fixation-naturalim_96',...
    'hermes_20180110_fixation-naturalim_86',...
    'hermes_20180110_fixation-naturalim_96',...
    'hermes_20180118_fixation-naturalim_86B',...
    'hermes_20180118_fixation-naturalim_86G',...
    'hermes_20180118_fixation-naturalim_86R',...
    'hermes_20180122_fixation-naturalim_86k',...
    'hermes_20180122_fixation-naturalim_86B',...
    'hermes_20180122_fixation-naturalim_86G',...
    'hermes_20180122_fixation-naturalim_86R',...
    'hermes_20180123_fixation-naturalim_96',...
    {
    'hermes_20180124_fixation-naturalim_96',...
    'hermes_20180124_fixation-naturalim_96b',...
    },...
    {
    'hermes_20180125_fixation-naturalim_97',...
    'hermes_20180125_fixation-naturalim_97b',...
    },...
    'hermes_20180125_fixation-naturalim_98',...
    'hermes_20180126_fixation-naturalim_96',...
    'hermes_20180129_fixation-naturalim_101',...
    'hermes_20180129_fixation-naturalim_102',...
    'hermes_20180129_fixation-naturalim_101',...
    'hermes_20180131_fixation-naturalim_103B',...
    'hermes_20180131_fixation-naturalim_103Y',...
    'hermes_20180201_fixation-naturalim_103E',...
    'hermes_20180201_fixation-naturalim_103K',...
    'hermes_20180202_fixation-naturalim_103E',...
    'hermes_20180202_fixation-naturalim_103G',...
    'hermes_20180202_fixation-naturalim_103R',...
    'hermes_20180205_fixation-naturalim_102',...
    'hermes_20180207_fixation-naturalim_103E',...
    'hermes_20180207_fixation-naturalim_103G3',...
    'hermes_20180207_fixation-naturalim_103K',...
    'hermes_20180207_fixation-naturalim_103W',...
    'ares025a03',...
    'ares026a01',...
    'ares026a02',...
    'ares027a01',...
    'ares027a02',...
    'ares028a01',...
    'ares029a01',...
    'ares030a01',...
    'ares030a02',...
    'ares034a03',...
    'ares034a04',...
    'ares037a01',...
    'ares038a01',...
    'ares038a02',...
    'ares039a01',...
    'ares039a02',...
    'ares040a01',...
    'ares040a02',...
    'ares040a03',...
    'ares042a01',...
    'ares042a02',...
    };

%     };
% sessionList = {
% %     'hermes_20170703_fixation-naturalim_74',...
% % 'hermes_20170704_fixation-naturalim_75',...
% % 'hermes_20170706_fixation-naturalim_76',...
% % 'hermes_20170706_fixation-naturalim_77',...
% % 'hermes_20170712_fixation-naturalim_60',...
% % 'hermes_20170724_fixation-naturalim_70',...
% % 'hermes_20170725_fixation-naturalim_71',...
% % 'hermes_20180205_fixation-naturalim_102',...
% % 'hermes_20180207_fixation-naturalim_103E',...
% % 'hermes_20180207_fixation-naturalim_103G3',...
% % 'hermes_20180207_fixation-naturalim_103K',...
% % 'hermes_20180207_fixation-naturalim_103W'
%     'hermes_20180208_fixation-naturalim_103B2',...
%     'hermes_20180208_fixation-naturalim_103R2',...
%     'hermes_20180208_fixation-naturalim_103Y2',...
%     'hermes_20180209_fixation-naturalim_103G4',...
%     'hermes_20180209_fixation-naturalim_103W2',...
%     'hermes_20180213_fixation-naturalim_104',...
%     'hermes_20180213_fixation-naturalim_105',...
%     'hermes_20180213_fixation-naturalim_106',...
% };
% sessionList = {
%     %     'ares033a02',...
%     %     'ares033a03',...
%     %       'ares039a01',...
%     %     'ares039a02',...
% %     'ares040a01',...
% %     'ares040a02',...
% %     'ares040a03',...
% 'ares042a01',...
% 'ares042a02',...
%     };
% sessionList = {
%     'hermes_20170425_fixation-grating-orientation-v2_1',...
% %     'hermes_20171208_fixation-grating-orientation-v2_2'
% };

sessionList = {
        'hermes_20171113_fixation-color-masksize_78',...
%     'hermes_20171114_fixation-color-masksize_78b',...
%     'hermes_20171116_fixation-color-masksize_78',...
    {
    'hermes_20171113_fixation-color-masksize_78',...
    'hermes_20171114_fixation-color-masksize_78b',...
    'hermes_20171116_fixation-color-masksize_78',...
    },...
%     {
%     'hermes_20171115_fixation-color-masksize_79',...
%     'hermes_20171117_fixation-color-masksize_79b',...
%     },...
%         'hermes_20171115_fixation-color-masksize_79',...
%     'hermes_20171117_fixation-color-masksize_79b',...
% %     'hermes_20170519_fixation-color-masksize_42',...
% %     'ares023a02',...
% %     'ares024a01',...
% %     {
% %     'ares025a01',...
% %     'ares025a02',...
% %     }
};

% sessionList = {
%     'hermes_20171113_fixation-color-masksize_78',...
%     'hermes_20171114_fixation-color-masksize_78b',...
%     'hermes_20171116_fixation-color-masksize_78',...
%     };

%% Functions
cfg = [];
n = 0;
for ses = 1:length(sessionList)
    n = n + 1;
    
    % get monkey dirs
    if iscell(sessionList{ses})
        monkeyName = sessionList{ses}{1}(1:4);
    else
        monkeyName = sessionList{ses}(1:4);
    end
    if strcmp(monkeyName, 'herm'); monkeyName = 'Hermes'; end
    if strcmp(monkeyName, 'ares'); monkeyName = 'Ares'; end
    if strcmp(monkeyName, 'isis'); monkeyName = 'Isis'; end
    
    if iscell(sessionList{ses})
        
        newSave = fullfile(saveDir, sesType, monkeyName, sessionList{ses});
        newDir = fullfile(dataDir, monkeyName, sesType, sessionList{ses});
    else
        newSave = fullfile(saveDir, sesType, monkeyName, sessionList{ses});
        newDir = fullfile(dataDir, monkeyName, sesType, sessionList{ses});
    end
    
    % set dirs
    cfg{n}.inputfile = newDir;
    cfg{n}.outputfile = newSave;
    cfg{n}.name = monkeyName;
    cfg{n}.type = sesType;
    cfg{n}.tag = batchTag;
    
    % set processing
    cfg{n}.filterLineNoise = ~strcmp(monkeyName, 'Hermes');
    cfg{n}.getBadChannels = false;
    
    % set analysis options
    cfg{n}.runBaseline = true;
    cfg{n}.runErrorBars = true;
    cfg{n}.runPSTH = true;
    cfg{n}.runTimelockLFP = true;
    cfg{n}.runTimelockMUAX = true;
    cfg{n}.runConnectivity = true;
    cfg{n}.runTFR = true;
    cfg{n}.runSTA = false;
    cfg{n}.runSFC = true;
    
    % params
    cfg{n}.timeAll = [-0.5 1.2];
    cfg{n}.timeEvent = [0 1.2];
    cfg{n}.timeBaseline = [-0.5 0];
    cfg{n}.timeSustained = [0.25 0.75];
    cfg{n}.flagSecond = false;
    if strcmp(sesType, 'NatImSEQ')
        cfg{n}.timeSustained_First = [0.25 0.6];
        cfg{n}.timeSustained_Second = [0.25 0.6]+0.6;
        cfg{n}.timeBaseline = [-0.45 -.10];
    end
end

%% Run analysis
tdt_analysis_AP(cfg, 'slurm');